<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Flappy Jollibee 完全版</title>
  <style>
    html, body {
      margin: 0; padding: 0;
      width: 100%; height: 100%;
      background: #70c5ce;
      overflow: hidden;
      touch-action: none;
      user-select: none;
    }
    canvas {
      display: block;
    }
    #restartButton {
      display: none;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 30px 60px;
      font-size: 28px;
      background-color: #f44336;
      color: white;
      border: none;
      border-radius: 12px;
      z-index: 10;
    }
  </style>
</head>
<body>
<canvas id="gameCanvas"></canvas>
<button id="restartButton">リスタート</button>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const restartButton = document.getElementById("restartButton");
function isMobile() {
  return /Mobi|Android/i.test(navigator.userAgent);
}

// 設定
let scrollX = 0;
const worldWidth = 2000; // ← ゴールまでの距離
const jollibee = {
  x: 100,
  y: canvas.height / 2,
  width: 60,
  height: 90,
  velocity: 0,
};
const gravity = isMobile() ? 0.6 : 0.4;
const jumpStrength = isMobile() ? -10 : -8;
let gameOver = false;
let gameStarted = false;
let clear = false;
let score = 0;

const pipes = [];
const items = [];
const floatingTexts = [];

const pipeGap = 180;
const pipeWidth = 80;
const pipeSpeed = 2;

// 画像読み込み
const jollibeeImg = new Image();
jollibeeImg.src = "jollibee.png";

const backgroundImg = new Image();
backgroundImg.src = "background.jpg";

const handImg = new Image();
handImg.src = "hand.png";

const goalImg = new Image();
goalImg.src = "jollibee-store.png";

const startImg = new Image();
startImg.src = "start-screen.png";

const emojis = [
  { emoji: '🍗', value: 100 },
  { emoji: '🍝', value: 5 },
  { emoji: '🍔', value: -200 },
];
function spawnPipe() {
  const topHeight = Math.random() * (canvas.height - pipeGap - 100) + 50;
  pipes.push({ x: worldWidth, topHeight, counted: false });

  if (Math.random() < 0.5) {
    const item = emojis[Math.floor(Math.random() * emojis.length)];
    items.push({
      x: worldWidth,
      y: topHeight + pipeGap / 2,
      emoji: item.emoji,
      value: item.value,
      collected: false
    });
  }
}

function drawStartScreen() {
  ctx.drawImage(startImg, 0, 0, canvas.width, canvas.height);
}

function drawBackground() {
  ctx.drawImage(backgroundImg, -scrollX % canvas.width, 0, canvas.width, canvas.height);
  ctx.drawImage(backgroundImg, canvas.width - scrollX % canvas.width, 0, canvas.width, canvas.height);
}

function drawJollibee() {
  ctx.drawImage(jollibeeImg, jollibee.x, jollibee.y, jollibee.width, jollibee.height);
}

function drawPipes() {
  pipes.forEach(pipe => {
    const drawX = pipe.x - scrollX;
    ctx.drawImage(handImg, drawX, 0, pipeWidth, pipe.topHeight);
    ctx.save();
    ctx.scale(1, -1);
    ctx.drawImage(handImg, drawX, -(pipe.topHeight + pipeGap + (canvas.height - pipe.topHeight - pipeGap)), pipeWidth, canvas.height - pipe.topHeight - pipeGap);
    ctx.restore();
  });
}

function drawItems() {
  ctx.font = `40px sans-serif`;
  items.forEach(item => {
    ctx.fillText(item.emoji, item.x - scrollX, item.y);
  });
}

function drawFloatingTexts() {
  ctx.font = `24px sans-serif`;
  floatingTexts.forEach(text => {
    ctx.globalAlpha = text.alpha;
    ctx.fillStyle = text.value > 0 ? "yellow" : "red";
    ctx.fillText(text.text, text.x - scrollX, text.y);
  });
  ctx.globalAlpha = 1.0;
}

function drawGoal() {
  const goalX = worldWidth - 200;
  ctx.drawImage(goalImg, goalX - scrollX, canvas.height - 200, 200, 150);
}

function drawText(text, size, y) {
  ctx.fillStyle = 'white';
  ctx.font = `${size}px sans-serif`;
  ctx.textAlign = 'center';
  ctx.fillText(text, canvas.width / 2, y);
}

function checkCollision() {
  if (clear) return;

  for (let pipe of pipes) {
    const x = pipe.x - scrollX;
    if (
      jollibee.x + jollibee.width > x &&
      jollibee.x < x + pipeWidth &&
      (jollibee.y < pipe.topHeight || jollibee.y + jollibee.height > pipe.topHeight + pipeGap)
    ) {
      gameOver = true;
    }
  }

  items.forEach(item => {
    if (
      !item.collected &&
      jollibee.x + jollibee.width > item.x - scrollX &&
      jollibee.x < item.x - scrollX + 40 &&
      jollibee.y < item.y &&
      jollibee.y + jollibee.height > item.y - 40
    ) {
      score += item.value;
      item.collected = true;
      floatingTexts.push({
        text: (item.value > 0 ? "+" : "") + item.value + "pt",
        x: item.x,
        y: item.y,
        value: item.value,
        alpha: 1.0
      });
    }
  });

  if (jollibee.y < 0 || jollibee.y + jollibee.height > canvas.height) {
    gameOver = true;
  }

  if (jollibee.x + scrollX >= worldWidth - 200) {
    clear = true;
  }
}

function update() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  if (!gameStarted) {
    drawStartScreen();
    drawText("画面タップでスタート", 24, canvas.height * 0.9);
    requestAnimationFrame(update);
    return;
  }

  drawBackground();

  if (!gameOver && !clear) {
    jollibee.velocity += gravity;
    jollibee.y += jollibee.velocity;
    scrollX += pipeSpeed;

    pipes.forEach(pipe => pipe.x -= 0);
    items.forEach(item => item.x -= 0);
    floatingTexts.forEach(text => {
      text.y -= 1;
      text.alpha -= 0.02;
    });

    checkCollision();

    if (pipes.length === 0 || pipes[pipes.length - 1].x - scrollX < canvas.width / 3) {
      spawnPipe();
    }

    floatingTexts.filter(text => text.alpha > 0);
  }

  drawGoal();
  drawPipes();
  drawItems();
  drawFloatingTexts();
  drawJollibee();
  drawText(`スコア: ${score} pt`, 24, 40);

  if (gameOver) {
    drawText("GAME OVER", 40, canvas.height / 2);
    showRestartButton();
  } else if (clear) {
    drawText("🎉 マニラに到着！", 40, canvas.height / 2);
    showRestartButton();
  }

  requestAnimationFrame(update);
}

function jump() {
  if (!gameStarted) {
    gameStarted = true;
    score = 0;
    jollibee.velocity = 0;
    jollibee.y = canvas.height / 2;
    pipes.length = 0;
    items.length = 0;
    floatingTexts.length = 0;
    scrollX = 0;
    gameOver = false;
    clear = false;
  }

  if (!gameOver && !clear) {
    jollibee.velocity = jumpStrength;
  }
}

function showRestartButton() {
  restartButton.style.display = "block";
}
function hideRestartButton() {
  restartButton.style.display = "none";
}
function restartGame() {
  hideRestartButton();
  gameStarted = false;
}

canvas.addEventListener("touchstart", jump);
restartButton.addEventListener("click", restartGame);
jollibeeImg.onload = () => update();
</script>
</body>
</html>
